/**
 * 移动端 Web/App 样式兼容性修复
 * 
 * 解决移动端 WebView 和 App 中的常见样式问题
 * 基于 W3C 标准和最佳实践
 */

/* ==================== 触摸交互优化 ==================== */

/**
 * 消除点击延迟（300ms 延迟问题）
 * 
 * 问题：移动端浏览器需要等待 300ms 判断单击/双击
 * 解决：使用 touch-action: manipulation 禁用双击缩放
 */
* {
  /* 禁用双击缩放，消除点击延迟 */
  touch-action: manipulation;
}

/* 允许滚动的容器 */
.scrollable,
[style*='overflow'],
[style*='overflow-y'],
[style*='overflow-x'] {
  touch-action: pan-y pan-x;
}

/* ==================== 文本选择控制 ==================== */

/**
 * 禁用不必要的文本选择
 * 
 * 问题：移动端长按会选中文本，影响交互体验
 * 解决：交互元素禁用选择，文本内容允许选择
 */

/* 交互元素禁用文本选择 */
button,
a,
.n-button,
.n-input,
.n-select,
.interactive {
  -webkit-user-select: none;
  user-select: none;

  /* 移除点击高亮（iOS Safari） */
  -webkit-tap-highlight-color: transparent;
  tap-highlight-color: transparent;
}

/* 文本输入框允许选择 */
input,
textarea,
[contenteditable='true'],
.selectable {
  -webkit-user-select: text;
  user-select: text;
}

/* ==================== 输入框优化 ==================== */

/**
 * 输入框样式重置和优化
 * 
 * 问题：
 * 1. iOS Safari 输入框聚焦时字体 < 16px 会自动缩放
 * 2. 浏览器默认样式不一致
 * 3. 自动填充样式影响设计
 */

input,
textarea,
select {
  /* 移除默认样式 */
  -webkit-appearance: none;
  appearance: none;

  /* 移除 iOS 阴影和边框 */
  -webkit-box-shadow: none;
  box-shadow: none;

  /* 确保字体大小至少 16px（防止 iOS 自动缩放） */
  font-size: 16px;

  /* 移除默认边框（如果需要自定义边框） */
  /* border: none; */

  /* 移除默认轮廓 */
  outline: none;
}

/* 移除 iOS Safari 输入框内阴影 */
input[type='text'],
input[type='password'],
input[type='email'],
input[type='tel'],
input[type='number'],
input[type='search'],
textarea {
  -webkit-appearance: none;
  appearance: none;
}

/* 自动填充样式修复 */
input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus,
input:-webkit-autofill:active {
  /* 覆盖黄色背景 */
  -webkit-box-shadow: 0 0 0 1000px var(--apple-bg-primary, var(--bg-primary)) inset !important;
  -webkit-text-fill-color: var(--apple-text-primary, var(--text-primary)) !important;

  /* 延迟背景色变化（避免闪烁） */
  transition: background-color 5000s ease-in-out 0s;
}

/* ==================== Safe Area 适配 ==================== */

/**
 * 适配刘海屏和底部安全区域
 * 
 * 使用 env() 函数获取安全区域尺寸
 * 参考：https://developer.mozilla.org/en-US/docs/Web/CSS/env
 */

/* 安全区域适配工具类 */
.safe-area-top {
  padding-top: env(safe-area-inset-top, 0);
}

.safe-area-bottom {
  padding-bottom: env(safe-area-inset-bottom, 0);
}

.safe-area-left {
  padding-left: env(safe-area-inset-left, 0);
}

.safe-area-right {
  padding-right: env(safe-area-inset-right, 0);
}

.safe-area-all {
  padding-top: env(safe-area-inset-top, 0);
  padding-bottom: env(safe-area-inset-bottom, 0);
  padding-left: env(safe-area-inset-left, 0);
  padding-right: env(safe-area-inset-right, 0);
}

/* 固定定位元素的安全区域适配 */
.fixed-top-safe {
  top: env(safe-area-inset-top, 0);
}

.fixed-bottom-safe {
  bottom: env(safe-area-inset-bottom, 0);
}

/* ==================== 滚动优化 ==================== */

/**
 * 移动端滚动性能优化
 * 
 * 问题：移动端滚动需要硬件加速
 * 解决：启用硬件加速滚动
 */

.scrollable,
[style*='overflow'] {
  /* 启用硬件加速滚动（iOS Safari） */
  -webkit-overflow-scrolling: touch;
  overflow-scrolling: touch;

  /* 优化滚动性能 */
  will-change: scroll-position;

  /* 触发硬件加速 */
  transform: translateZ(0);

  /* 防止滚动穿透 */
  overscroll-behavior: contain;
}

/* ==================== 动画性能优化 ==================== */

/**
 * 移动端动画性能优化
 * 
 * 问题：复杂动画可能导致卡顿
 * 解决：使用 GPU 加速的属性
 */

.animate,
[class*='animate-'] {
  /* 提示浏览器优化 */
  will-change: transform, opacity;

  /* 触发硬件加速 */
  transform: translateZ(0);
  backface-visibility: hidden;

  /* 优化渲染 */
  perspective: 1000px;
}

/* 尊重用户的减少动画偏好 */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}

/* ==================== 字体渲染优化 ==================== */

/**
 * 移动端字体渲染优化
 * 
 * 问题：字体可能模糊
 * 解决：优化字体渲染设置
 */

body {
  /* 字体平滑 */
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;

  /* 防止字体大小调整 */
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

/* ==================== 图片优化 ==================== */

/**
 * 移动端图片加载优化
 */

img {
  /* 图片渲染优化 */
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;

  /* 延迟加载占位符 */
  content-visibility: auto;

  /* 防止图片被拖拽 */
  -webkit-user-drag: none;
  user-drag: none;
}

/* ==================== 弹窗滚动穿透修复 ==================== */

/**
 * 弹窗打开时防止背景滚动
 */

.modal-open,
.dialog-open {
  overflow: hidden;
  position: fixed;
  width: 100%;
  height: 100%;
}

/* 或者使用 overscroll-behavior */
body {
  overscroll-behavior-y: contain;
}

/* ==================== 表单优化 ==================== */

/**
 * 表单验证样式
 */

/* 移除默认验证样式 */
input:invalid,
textarea:invalid,
select:invalid {
  box-shadow: none;
}

/* 自定义验证样式 */
input:invalid:not(:focus):not(:placeholder-shown),
textarea:invalid:not(:focus):not(:placeholder-shown) {
  border-color: var(--apple-red, var(--color-error));
}

/* ==================== 性能优化 ==================== */

/**
 * 使用 contain 属性优化渲染
 */

.container-optimized {
  contain: layout style paint;
}

/* 列表优化 */
.list-optimized {
  contain: layout style paint;
  content-visibility: auto;
}

/* ==================== 特定平台修复 ==================== */

/**
 * iOS Safari 特定修复
 */

@supports (-webkit-touch-callout: none) {
  /* iOS Safari 特定样式 */
  body {
    /* iOS Safari 滚动优化 */
    -webkit-overflow-scrolling: touch;
  }

  /* iOS Safari 输入框修复 */
  input,
  textarea {
    font-size: 16px; /* 防止自动缩放 */
  }
}

/**
 * Android WebView 特定修复
 */

@supports not (-webkit-touch-callout: none) {
  /* Android 特定样式 */
}

/* ==================== 响应式断点 ==================== */

/**
 * 移动端优先的响应式设计
 */

/* 小屏幕（手机） */
@media (max-width: 640px) {
  html {
    font-size: 14px;
  }
}

/* 中等屏幕（平板） */
@media (min-width: 641px) and (max-width: 1024px) {
  html {
    font-size: 15px;
  }
}

/* 大屏幕（桌面） */
@media (min-width: 1025px) {
  html {
    font-size: 16px;
  }
}
