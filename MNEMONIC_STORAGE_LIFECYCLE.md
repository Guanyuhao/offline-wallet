# 助记词存储生命周期说明

本文档详细说明助记词在两个存储位置的生命周期管理和典型场景分析。

## 存储位置概览

### 1. 内存中的加密存储

- **位置**: 浏览器内存（JavaScript 变量）
- **加密方式**: AES-GCM 256位加密
- **用途**: 当前会话中使用，用于签名交易、派生地址等操作
- **特点**: 应用关闭后自动清除，不持久化

### 2. 系统级别的加密存储

- **位置**: 系统密钥库（Keychain/Keystore）
  - iOS/macOS: Keychain Services
  - Android: Keystore
  - Windows: Credential Manager
  - Linux: Secret Service API
- **加密方式**: AES-GCM + Argon2 密码哈希
- **用途**: 持久化存储，应用重启后仍可恢复
- **特点**: 需要用户密码才能访问

---

## 一、内存中的加密存储

### 📝 创建时机

#### 1. **创建钱包时**

- **触发场景**: 用户创建新钱包或导入钱包
- **操作流程**:
  1. 临时使用明文助记词派生地址
  2. 派生完成后，加密并存储到内存
  3. 立即清除明文助记词
  4. 钱包状态变为已解锁

#### 2. **解锁钱包时**

- **触发场景**:
  - 用户输入密码解锁（从系统级存储读取助记词）
  - 生物识别解锁成功
- **操作流程**:
  1. 从系统级存储读取并解密助记词（需要密码）
  2. 将助记词加密存储到内存
  3. 钱包状态变为已解锁

### 🗑️ 删除时机

#### 1. **手动锁定钱包**

- **触发场景**: 用户手动锁定钱包
- **操作**: 清除内存中的加密数据，但保留地址信息
- **结果**: 钱包变为锁定状态，只能查看地址，无法签名交易

#### 2. **自动锁定**

- **触发条件**:
  - 5分钟无用户活动（鼠标、键盘、触摸等）
  - 应用进入后台（如果启用了后台锁定）
- **操作**: 自动清除内存中的加密助记词
- **结果**: 钱包自动锁定，需要重新输入密码解锁

#### 3. **清除钱包**

- **触发场景**:
  - 用户退出钱包
  - 忘记密码后重新导入
- **操作**: 清除所有内存数据，包括加密助记词和地址
- **结果**: 钱包完全清除，需要重新创建或导入

#### 4. **创建钱包失败**

- **触发场景**: 创建钱包过程中发生错误
- **操作**: 自动清理所有临时数据
- **结果**: 钱包创建失败，内存中无残留数据

---

## 二、系统级别的加密存储

### 📝 创建时机

#### 1. **启用加密存储时**

- **触发场景**: 用户在设置中启用密码保护
- **前提条件**:
  - 钱包已创建（内存中有助记词）
  - 用户设置了密码（至少8个字符）
- **操作流程**:
  1. 从内存读取助记词
  2. 使用用户密码加密后存储到系统密钥库
  3. 保存地址到 localStorage（因为现在有加密助记词了）
- **结果**: 助记词持久化存储，应用重启后仍可恢复

### 🗑️ 删除时机

#### 1. **禁用加密存储时**

- **触发场景**: 用户在设置中禁用密码保护
- **操作流程**:
  1. 删除系统密钥库中的加密助记词
  2. 删除生物识别密码（如果已启用）
  3. 清除 localStorage 中的地址缓存（因为没有助记词，地址无意义）
- **结果**:
  - 当前会话中钱包仍可使用（内存中还有）
  - 应用重启后需要重新导入助记词

#### 2. **退出钱包时**

- **触发场景**: 用户确认退出钱包
- **操作流程**:
  1. 清除内存中的加密助记词
  2. 清除系统密钥库中的加密助记词
  3. 清除生物识别密码
  4. 清除 localStorage 中的地址缓存
- **结果**: 所有数据完全清除，钱包完全退出

---

## 三、典型场景分析

### 场景1: 创建钱包并启用加密存储

**步骤1: 创建钱包**

- 内存加密存储: ✅ 已创建
- 系统级存储: ❌ 不存在
- 钱包状态: 已解锁，可以签名交易
- 地址缓存: ❌ 未保存（因为没有系统级加密助记词）

**步骤2: 启用加密存储（设置密码）**

- 内存加密存储: ✅ 保持不变（仍可使用）
- 系统级存储: ✅ 已创建（新增）
- 钱包状态: 已解锁，可以签名交易
- 地址缓存: ✅ 已保存（因为现在有系统级加密助记词了）

**步骤3: 应用重启**

- 内存加密存储: ❌ 已清除（应用关闭时自动清除）
- 系统级存储: ✅ 仍存在（持久化存储）
- 钱包状态: 已锁定，需要输入密码解锁
- 地址缓存: ✅ 仍存在（可以从 localStorage 恢复）

**步骤4: 输入密码解锁**

- 内存加密存储: ✅ 重新创建（从系统级存储读取）
- 系统级存储: ✅ 保持不变
- 钱包状态: 已解锁，可以签名交易
- 地址缓存: ✅ 保持不变

---

### 场景2: 创建钱包但未启用加密存储

**步骤1: 创建钱包**

- 内存加密存储: ✅ 已创建
- 系统级存储: ❌ 不存在
- 钱包状态: 已解锁，可以签名交易
- 地址缓存: ❌ 未保存

**步骤2: 应用重启**

- 内存加密存储: ❌ 已清除（应用关闭时自动清除）
- 系统级存储: ❌ 不存在
- 钱包状态: 已锁定，且无法解锁（没有系统级存储）
- 地址缓存: ❌ 不存在（即使之前有，也会被清除）

**步骤3: 用户需要重新导入助记词**

- 用户必须重新输入12个或24个助记词
- 重新创建钱包

---

### 场景3: 解锁钱包（有系统级存储）

**步骤1: 应用启动，检测到有系统级存储**

- 内存加密存储: ❌ 不存在
- 系统级存储: ✅ 存在
- 钱包状态: 已锁定，显示解锁页面
- 地址缓存: ✅ 存在（从 localStorage 恢复，可以显示地址）

**步骤2: 用户输入密码解锁**

- 内存加密存储: ✅ 已创建（从系统级存储读取并加密）
- 系统级存储: ✅ 保持不变
- 钱包状态: 已解锁，可以签名交易
- 地址缓存: ✅ 保持不变

**步骤3: 用户使用钱包（签名交易等）**

- 内存加密存储: ✅ 存在（用于签名交易）
- 系统级存储: ✅ 保持不变
- 钱包状态: 已解锁

---

### 场景4: 自动锁定

**步骤1: 钱包已解锁状态**

- 内存加密存储: ✅ 存在
- 系统级存储: ✅ 存在
- 钱包状态: 已解锁，可以签名交易

**步骤2: 5分钟无活动或应用进入后台**

- 内存加密存储: ❌ 被清除（自动锁定）
- 系统级存储: ✅ 保持不变
- 钱包状态: 已锁定，只能查看地址
- 地址缓存: ✅ 保持不变

**步骤3: 用户需要重新输入密码解锁**

- 内存加密存储: ✅ 重新创建（从系统级存储读取）
- 系统级存储: ✅ 保持不变
- 钱包状态: 已解锁，可以签名交易

---

### 场景5: 禁用加密存储

**步骤1: 钱包已启用加密存储**

- 内存加密存储: ✅ 存在
- 系统级存储: ✅ 存在
- 钱包状态: 已解锁，可以签名交易
- 地址缓存: ✅ 存在

**步骤2: 用户在设置中禁用加密存储**

- 内存加密存储: ✅ 保持不变（当前会话仍可使用）
- 系统级存储: ❌ 被删除
- 钱包状态: 已解锁，可以签名交易（当前会话）
- 地址缓存: ❌ 被清除（因为没有系统级加密助记词了）

**步骤3: 应用重启**

- 内存加密存储: ❌ 已清除（应用关闭时自动清除）
- 系统级存储: ❌ 不存在（已被删除）
- 钱包状态: 已锁定，且无法解锁（没有系统级存储）
- 地址缓存: ❌ 不存在（已被清除）

**步骤4: 用户需要重新导入助记词**

- 用户必须重新输入12个或24个助记词
- 重新创建钱包

---

### 场景6: 退出钱包

**步骤1: 钱包正常运行**

- 内存加密存储: ✅ 存在
- 系统级存储: ✅ 存在
- 钱包状态: 已解锁
- 地址缓存: ✅ 存在

**步骤2: 用户确认退出钱包**

- 内存加密存储: ❌ 被清除
- 系统级存储: ❌ 被删除
- 钱包状态: 已清除
- 地址缓存: ❌ 被清除

**步骤3: 应用重启**

- 所有数据已清除
- 用户需要重新创建或导入钱包

---

### 场景7: 忘记密码

**步骤1: 钱包已启用加密存储**

- 内存加密存储: ✅ 存在（当前会话）
- 系统级存储: ✅ 存在
- 钱包状态: 已解锁（当前会话）

**步骤2: 应用重启，用户忘记密码**

- 内存加密存储: ❌ 已清除
- 系统级存储: ✅ 存在（但无法访问）
- 钱包状态: 已锁定，无法解锁

**步骤3: 用户选择"忘记密码"**

- 内存加密存储: ❌ 不存在
- 系统级存储: ❌ 被删除（清除所有数据）
- 钱包状态: 已清除
- 地址缓存: ❌ 被清除

**步骤4: 用户重新导入助记词**

- 使用助记词重新创建钱包
- 可以选择是否启用加密存储

---

## 四、地址存储策略

### 地址存储规则

**地址仅在存在系统级加密助记词时存储到 localStorage**

- ✅ **有系统级加密助记词**: 地址会保存到 localStorage，应用重启后可以恢复显示
- ❌ **没有系统级加密助记词**: 地址不会保存，即使之前有缓存也会被清除

### 原因

地址是从助记词派生的，没有助记词就没有意义：

- 没有助记词，无法签名交易
- 没有助记词，无法派生新地址
- 只显示地址但没有助记词，对用户没有实际价值

### 地址缓存的生命周期

1. **启用加密存储时**: 地址立即保存到 localStorage
2. **禁用加密存储时**: 地址缓存立即清除
3. **退出钱包时**: 地址缓存被清除
4. **应用重启时**:
   - 如果有系统级加密助记词，地址从 localStorage 恢复
   - 如果没有系统级加密助记词，地址缓存被清除

---

## 五、重要注意事项

### ⚠️ 内存存储的特点

1. **临时性**: 应用关闭后自动清除
2. **会话内可用**: 只要应用运行且未锁定，就可以使用
3. **自动锁定**: 5分钟无活动或应用进入后台会自动清除
4. **安全性**: 即使被清除，也是加密存储，增加提取难度

### ⚠️ 系统级存储的特点

1. **持久性**: 应用重启后仍存在
2. **需要密码**: 必须输入密码才能访问
3. **可选功能**: 用户可以选择启用或禁用
4. **安全性**: 使用系统级密钥库，安全性高

### ⚠️ 安全建议

1. **启用加密存储**: 建议用户创建钱包后立即启用，避免应用重启后需要重新导入
2. **记住密码**: 如果忘记密码，需要使用助记词重新导入钱包
3. **定期备份**: 建议用户安全备份助记词（纸笔抄写，不要截图）
4. **不要禁用加密存储**: 除非确定不再需要持久化存储，否则不建议禁用

### ⚠️ 数据丢失风险

1. **未启用加密存储**: 应用重启后需要重新导入助记词
2. **忘记密码**: 需要使用助记词重新导入钱包
3. **丢失助记词**: 永久失去钱包访问权限，无法恢复
4. **退出钱包**: 所有数据被清除，需要重新创建或导入

---

## 六、存储状态对照表

| 场景                       | 内存加密存储 | 系统级存储 | 地址缓存 | 钱包状态 | 可执行操作 |
| -------------------------- | ------------ | ---------- | -------- | -------- | ---------- |
| 创建钱包后                 | ✅           | ❌         | ❌       | 已解锁   | 签名交易   |
| 启用加密存储后             | ✅           | ✅         | ✅       | 已解锁   | 签名交易   |
| 应用重启（有加密存储）     | ❌           | ✅         | ✅       | 已锁定   | 仅查看地址 |
| 解锁后                     | ✅           | ✅         | ✅       | 已解锁   | 签名交易   |
| 自动锁定后                 | ❌           | ✅         | ✅       | 已锁定   | 仅查看地址 |
| 禁用加密存储后（当前会话） | ✅           | ❌         | ❌       | 已解锁   | 签名交易   |
| 禁用加密存储后（重启）     | ❌           | ❌         | ❌       | 已锁定   | 需重新导入 |
| 退出钱包后                 | ❌           | ❌         | ❌       | 已清除   | 需重新创建 |

---

## 七、最佳实践

### 对于用户

1. **创建钱包后立即启用加密存储**: 避免应用重启后需要重新导入
2. **记住密码**: 密码是访问系统级存储的唯一方式
3. **安全备份助记词**: 用纸笔抄写，不要截图，多处备份
4. **不要禁用加密存储**: 除非确定不再需要持久化存储

### 对于开发者

1. **检查系统级存储**: 在应用启动时检查是否有加密助记词
2. **自动锁定机制**: 实现5分钟无活动自动锁定
3. **清除策略**: 没有系统级加密助记词时，清除地址缓存
4. **错误处理**: 创建钱包失败时，确保清除所有临时数据
