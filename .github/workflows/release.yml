# @Author liyongjie
# ä¸»å‘å¸ƒå·¥ä½œæµ - åè°ƒæ‰€æœ‰å¹³å°æ„å»ºå¹¶åˆ›å»º GitHub Release

name: Release

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      build_desktop:
        description: 'Build Desktop (Windows + macOS)'
        type: boolean
        default: true
      build_mobile:
        description: 'Build Mobile (iOS + Android)'
        type: boolean
        default: false
      create_release:
        description: 'Create GitHub Release'
        type: boolean
        default: true

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # æ¡Œé¢ç«¯æ„å»º
  # ============================================
  
  build-windows:
    name: ğŸªŸ Windows
    if: github.event_name != 'workflow_dispatch' || inputs.build_desktop
    uses: ./.github/workflows/build-windows.yml
    secrets:
      TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY_COLD_WALLET }}
      TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD_COLD_WALLET }}

  build-macos:
    name: ğŸ macOS
    if: github.event_name != 'workflow_dispatch' || inputs.build_desktop
    uses: ./.github/workflows/build-macos.yml
    secrets:
      TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY_COLD_WALLET }}
      TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD_COLD_WALLET }}

  # ============================================
  # ç§»åŠ¨ç«¯æ„å»ºï¼ˆå¯é€‰ï¼‰
  # ============================================
  
  build-mobile:
    name: ğŸ“± Mobile
    if: github.event_name == 'workflow_dispatch' && inputs.build_mobile
    uses: ./.github/workflows/build-mobile.yml
    secrets:
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_PROVISIONING_PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

  # ============================================
  # åˆ›å»º GitHub Release
  # ============================================
  
  create-release:
    name: ğŸš€ Create Release
    needs: [build-windows, build-macos]
    if: |
      always() &&
      !contains(needs.*.result, 'failure') &&
      (startsWith(github.ref, 'refs/tags/v') || 
       (github.event_name == 'workflow_dispatch' && inputs.create_release) ||
       github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="v$(node -p "require('./package.json').version")-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: List Artifacts
        run: |
          echo "ğŸ“ Downloaded artifacts:"
          find ./artifacts -type f -name "*.msi" -o -name "*.exe" -o -name "*.dmg" -o -name "*.apk" -o -name "*.ipa" | head -20

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Cold Wallet ${{ steps.version.outputs.version }}
          draft: ${{ !startsWith(github.ref, 'refs/tags/v') }}
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          generate_release_notes: true
          files: |
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.apk
            artifacts/**/*.ipa
          body: |
            ## ğŸ” Cold Wallet ${{ steps.version.outputs.version }}
            
            ### ğŸ“¥ ä¸‹è½½
            
            | å¹³å° | æ¶æ„ | ä¸‹è½½ |
            |------|------|------|
            | Windows | x64 | `.msi` / `.exe` |
            | macOS | Intel (x64) | `.dmg` |
            | macOS | Apple Silicon (arm64) | `.dmg` |
            
            ### âš¡ å¿«é€Ÿå¼€å§‹
            
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            2. å®‰è£…å¹¶è¿è¡Œ
            3. åˆ›å»ºæˆ–å¯¼å…¥é’±åŒ…
            
            ### ğŸ”’ å®‰å…¨æç¤º
            
            - è¯·ä»…ä»å®˜æ–¹æ¸ é“ä¸‹è½½
            - éªŒè¯æ–‡ä»¶å®Œæ•´æ€§åå†å®‰è£…
            - å¦¥å–„ä¿ç®¡åŠ©è®°è¯
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
