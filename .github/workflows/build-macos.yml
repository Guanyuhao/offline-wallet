# @Author liyongjie
# macOS 桌面构建工作流（Intel + Apple Silicon）

name: Build macOS

on:
  workflow_call:
    inputs:
      upload-artifacts:
        type: boolean
        default: true
    secrets:
      TAURI_PRIVATE_KEY:
        required: false
      TAURI_KEY_PASSWORD:
        required: false
      APPLE_CERTIFICATE:
        required: false
      APPLE_CERTIFICATE_PASSWORD:
        required: false
      APPLE_SIGNING_IDENTITY:
        required: false

jobs:
  build:
    name: macOS ${{ matrix.arch }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            target: x86_64-apple-darwin
            artifact-suffix: x64
          - arch: arm64
            target: aarch64-apple-darwin
            artifact-suffix: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env
        with:
          rust-targets: ${{ matrix.target }}

      - name: Build Frontend
        working-directory: packages/cold-wallet
        run: pnpm build

      - name: Build Tauri App
        working-directory: packages/cold-wallet
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: pnpm tauri build --target ${{ matrix.target }}

      - name: Upload Artifacts
        if: inputs.upload-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cold-wallet-macos-${{ matrix.artifact-suffix }}
          path: |
            packages/cold-wallet/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
          retention-days: 7

