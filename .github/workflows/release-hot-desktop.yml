name: Release Hot Wallet Desktop

on:
  push:
    tags:
      - 'hot-desktop-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š1.0.0ï¼‰'
        required: true

permissions:
  contents: write

jobs:
  build-windows:
    name: æ„å»º Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: 'packages/hot-wallet/src-tauri -> target'
      
      - name: Install Dependencies
        run: |
          pnpm install --frozen-lockfile
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Frozen lockfile failed, trying without..."
            pnpm install
          }
      
      - name: Build Tauri App
        working-directory: packages/hot-wallet
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY_HOT_WALLET }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD_HOT_WALLET }}
        run: pnpm tauri build --target x86_64-pc-windows-msvc
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hot-wallet-windows-x64
          path: |
            packages/hot-wallet/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
            packages/hot-wallet/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
          if-no-files-found: warn

  build-macos:
    name: æ„å»º macOS
    runs-on: macos-latest
    
    strategy:
      matrix:
        target:
          - arch: x86_64
            rust_target: x86_64-apple-darwin
          - arch: aarch64
            rust_target: aarch64-apple-darwin
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target.rust_target }}
      
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: 'packages/hot-wallet/src-tauri -> target'
          key: ${{ matrix.target.rust_target }}
      
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile || pnpm install
      
      - name: Build Tauri App
        working-directory: packages/hot-wallet
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY_HOT_WALLET }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD_HOT_WALLET }}
        run: pnpm tauri build --target ${{ matrix.target.rust_target }}
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hot-wallet-macos-${{ matrix.target.arch }}
          path: |
            packages/hot-wallet/src-tauri/target/${{ matrix.target.rust_target }}/release/bundle/dmg/*.dmg
            packages/hot-wallet/src-tauri/target/${{ matrix.target.rust_target }}/release/bundle/macos/*.app
          if-no-files-found: warn

  create-release:
    name: åˆ›å»º GitHub Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: always() && (needs.build-windows.result == 'success' || needs.build-macos.result == 'success')
    
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: Display structure
        run: ls -R ./artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          name: Hot Wallet Desktop ${{ github.ref_name }}
          body: |
            ## ğŸ–¥ï¸ Hot Wallet æ¡Œé¢ç‰ˆ
            
            ### æ”¯æŒå¹³å°
            - âœ… Windows x64 (.msi, .exe)
            - âœ… macOS Intel (.dmg, .app)
            - âœ… macOS Apple Silicon (.dmg, .app)
            
            ### å®‰è£…è¯´æ˜
            - **Windows**: ä¸‹è½½ .msi æˆ– .exe å®‰è£…åŒ…
            - **macOS**: ä¸‹è½½ .dmg æ–‡ä»¶ï¼Œæ‹–æ‹½åˆ° Applications
          files: |
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.app/**

